# Grants of scopes to repos or user groups, or parts of projects
#
# Format:
# - grant:
#   - <scope>
#   - ..
#   to:
#   - <grantee>
#   - ..
#
# The `grant` property specifies the scopes to be granted.  Each will have {..}
# parameters expanded with parameters from the grantees selected.
#
# ## Projects
#
# A grantee can either be a project or a user group.  A project looks like this:
#
# - projects:
#     level: [2, 3]  # condition
#     job: ["branch:default", "cron:*"]
#
# The top-level property can be `projects` or `project`, whichever reads better.
#
# The conditions select matching projects from projects.yml.  Each specifies a
# condition name and either a single value or an array of values.  For an array
# of values, a project with any value in the array is matched.  The conditions
# are AND'ed together.  Available conditions are:
#
# * access
# * level (as derived from access or directly specified)
# * alias
# * feature (projects with the given feature or for `!feature`, projects without)
# * is_try (true/false)
# * trust_domain
# * job
#
# "job" is a little special: it is a list of the jobs on the matching projects
# to which the grant applies.  These are suffixes to the `repo` roles,
# defaulting to "*":
#
# * * (all jobs on the repo)
# * branch:default (pushes to the repo)
# * cron:<job> (cron jobs; kleene-* is allowed)
# * action:<actionPerm> (action jobs; kleene-* is allowed)
#
# the following expansions of the granted scopes are performed:
#
# * {alias} (project alias)
# * {level} (numeric level; not substituted if this repo has no numeric level)
# * {repo_path} (path within repository (e.g. hg.mozilla.org or github.com, if repo is on that host)
# * {trust_domain}
#
# ## User Groups
#
# A user group grantee looks like this:
#
# - group: <groupName>
# or
# - groups: [<group1>, <group2>, ..]
#
# The property name can be `group` or `groups`, whichever reads better.
#
# The resulting scopes are granted to role `project:releng:ci-group:<groupName>`.
# Then `assume:project:releng:ci-group:<groupName>` to the appropriate access-control
# role, hopefully with the same name. This indirection exists because `mozilla-group`
# role changes need access to the cluster's root crendentials.
#
# No expansions are available for user groups.


# Platform roles

- grant:
  # Scopes assigned to credentials generated by taskcluster-login; so, to human users.
  # The `*` matches the user's identity as defined by the taskcluster-login service.
  - auth:create-client:<..>/*
  - auth:delete-client:<..>/*
  - auth:reset-access-token:<..>/*
  - auth:update-client:<..>/*
  - queue:get-artifact:login-identity/<..>/*
  - queue:create-task:built-in/succeed
  - queue:create-task:built-in/fail
  to:
  - roles:
    - login-identity:*

##
# scopes for all gecko-related projects

- grant:
  # Historically, comm-* branches used the gecko scheduler
  - queue:scheduler-id:gecko-level-{level}

  # coalescing routes support dropping unnecessary tasks under load
  - queue:route:coalesce.v1.{alias}.*

  # allow fetching secrets appropriate to this level
  - secrets:get:project/releng/{trust_domain}/build/level-{level}/*

  # Historically, gecko projects used unprefixed caches
  - docker-worker:cache:level-{level}-*
  - generic-worker:cache:level-{level}-*

  # Provide access to sccache buckets
  - assume:project:taskcluster:{trust_domain}:level-{level}-sccache-buckets
  - auth:gcp:access-token:sccache-3/tc-l{level}*

  # access to workers; all levels have access to the same workers, but at
  # different priorities and levels
  - queue:create-task:{priority}:aws-provisioner-v1/gecko-misc
  - queue:create-task:{priority}:aws-provisioner-v1/gecko-t-*
  - queue:create-task:{priority}:aws-provisioner-v1/gecko-{level}-*
  - queue:create-task:{priority}:releng-hardware/gecko-t-*
  - queue:create-task:{priority}:built-in/*
  - queue:create-task:{priority}:scriptworker-k8s/{trust_domain}-{level}-*
  - queue:create-task:{priority}:scriptworker-k8s/{trust_domain}-t-*
  - queue:create-task:{priority}:gecko-{level}/*
  - queue:create-task:{priority}:gecko-t/*
  to:
  - project:
      feature: gecko-roles

- grant:
  # access to workers; all levels have access to the same workers, but at
  # different priorities and levels
  - queue:create-task:{priority}:bitbar/gecko-t-*
  - queue:create-task:{priority}:gce/gecko-t-*
  - queue:create-task:{priority}:gce/gecko-{level}-*
  - queue:create-task:{priority}:gecko-{level}/*
  - queue:create-task:{priority}:gecko-t/*
  - queue:create-task:{priority}:releng-hardware/gecko-{level}-*
  - queue:create-task:{priority}:terraform-packet/gecko-t-*

  # access to openh264 artifacts; necessary for symbol upload and signing when
  # building new openh264 binaries
  - queue:get-artifact:private/openh264/*
  to:
  - project:
      feature: gecko-roles
      trust_domain: gecko

# moz-tree roles include the basic scopes available to version-control trees at
# each of the three Mozilla source-code management levels.  They are useful as
# shorthand to configure `repo:*` roles.  While most scopes are still contained
# in these grants, prefer to add new grants as separate stanzas in this file,
# and remove scopes from these grants.

# moz-tree:level:1:*
- grant:
  - docker-worker:capability:device:loopbackAudio
  - docker-worker:capability:device:loopbackVideo
  - docker-worker:capability:privileged
  - docker-worker:feature:allowPtrace
  - docker-worker:image:quay.io/mozilla/builder:*
  - docker-worker:image:quay.io/mozilla/decision:*
  - docker-worker:image:taskcluster/builder:*
  - docker-worker:image:taskcluster/tester:*
  - index:insert-task:garbage.*
  - notify:email:*
  - project:releng:balrog:channel:*
  - project:releng:balrog:server:dep
  - project:releng:beetmover:action:*
  - project:releng:beetmover:bucket:dep
  - project:releng:beetmover:bucket:maven-staging
  - project:releng:googleplay:dep
  - project:releng:ship-it:server:staging
  - project:releng:signing:cert:dep-signing
  - project:releng:signing:format:*
  - purge-cache:aws-provisioner-v1/*
  - queue:create-task:aws-provisioner-v1/ami-test*
  - queue:create-task:dummy-test-provisioner/dummy-test-type
  - queue:create-task:gecko-t-tc-worker/*
  - queue:create-task:localprovisioner/*
  - queue:create-task:low:scriptworker-prov-v1/balrog-dev
  - queue:create-task:low:scriptworker-prov-v1/beetmoverworker-dev
  - queue:create-task:medium:proj-autophone/*
  - queue:create-task:medium:proj-awfy/*
  - queue:create-task:packetnet/*
  - queue:create-task:tc-worker-provisioner/*
  - queue:create-task:test-dummy-provisioner/*
  - queue:create-task:low:aws-provisioner-v1/ami-test*
  - queue:create-task:low:bitbar/gecko-t-*
  - queue:create-task:low:dummy-test-provisioner/dummy-test-type
  - queue:create-task:low:localprovisioner/*
  - queue:create-task:low:manual-packet/tc-worker-qemu-v1
  - queue:create-task:low:packetnet/*
  - queue:create-task:low:releng-hardware/my-talos
  - queue:create-task:low:scriptworker-prov-v1/dep-pushapk
  - queue:create-task:low:scriptworker-prov-v1/shipit-dev*
  - queue:create-task:low:tc-worker-provisioner/*
  - queue:create-task:low:test-dummy-provisioner/*
  - queue:get-artifact:project/gecko/android-*
  - queue:route:index.garbage.*
  - queue:route:notify.*
  - secrets:get:project/taskcluster/gecko/hgfingerprint
  - secrets:get:project/taskcluster/gecko/hgmointernal
  - queue:create-task:low:manual-packet/tc-worker-docker-v0
  - queue:create-task:low:terraform-packet/tc-worker-docker-v1
  - queue:create-task:low:terraform-packet/tc-worker-docker-v1-*
  - queue:create-task:medium:terraform-packet/tc-worker-docker-v1-*
  to:
  - projects:
      feature: gecko-roles
      level: [1, 2, 3]

# moz-tree:level:1:gecko
- grant:
  - generic-worker:allow-rdp:aws-provisioner-v1/gecko-1-b-win*
  - generic-worker:allow-rdp:aws-provisioner-v1/gecko-t-win*
  - generic-worker:allow-rdp:gecko-1/win*
  - generic-worker:allow-rdp:gecko-t/win*
  - generic-worker:os-group:aws-provisioner-v1/gecko-t-win7-32/Administrators
  - generic-worker:os-group:aws-provisioner-v1/gecko-t-win10-64/Administrators
  - generic-worker:os-group:aws-provisioner-v1/gecko-t-win10-64-alpha/Administrators
  - generic-worker:os-group:gecko-t/t-win7-32/Administrators
  - generic-worker:os-group:gecko-t/t-win10-64/Administrators
  - generic-worker:os-group:gecko-t/t-win10-64-alpha/Administrators
  - generic-worker:run-as-administrator:aws-provisioner-v1/gecko-t-win10-64
  - generic-worker:run-as-administrator:aws-provisioner-v1/gecko-t-win10-64-alpha
  - generic-worker:run-as-administrator:gecko-t/t-win10-64
  - generic-worker:run-as-administrator:gecko-t/t-win10-64-alpha
  - project:releng:addons.mozilla.org:server:staging
  - project:releng:balrog:action:*
  - project:releng:beetmover:bucket:dep-partner
  - project:releng:bouncer:action:*
  - project:releng:bouncer:server:staging
  - project:releng:bouncer:server:staging-nazgul
  - project:releng:ship-it:action:mark-as-shipped
  - project:releng:ship-it:action:mark-as-started
  - project:releng:snapcraft:firefox:mock
  - project:releng:treescript:action:*
  - project:releng:treescript:action:tagging
  - queue:create-task:low:manual-packet/tc-worker-docker-v1
  - queue:create-task:low:scriptworker-prov-v1/addon-dev
  - queue:create-task:low:scriptworker-prov-v1/balrog-dev
  - queue:create-task:low:scriptworker-prov-v1/bouncer-dev
  - queue:create-task:low:scriptworker-prov-v1/dep-pushsnap
  - queue:create-task:low:scriptworker-prov-v1/signing-linux-dev
  - queue:create-task:low:scriptworker-prov-v1/signing-mac-dev
  - queue:create-task:low:scriptworker-prov-v1/depsigning
  - queue:create-task:low:scriptworker-prov-v1/depsigning-mac-v1
  - queue:create-task:low:scriptworker-prov-v1/treescript-dev
  - queue:create-task:low:terraform-packet/*
  - queue:get-artifact:releng/partner/*
  to:
  - projects:
      feature: gecko-roles
      level: [1, 2, 3]
      trust_domain: gecko

# moz-tree:level:1:comm
- grant:
  - project:comm:thunderbird:releng:balrog:action:*
  - project:comm:thunderbird:releng:balrog:server:dep
  - project:comm:thunderbird:releng:beetmover:action:*
  - project:comm:thunderbird:releng:beetmover:bucket:dep
  - project:comm:thunderbird:releng:bouncer:action:*
  - project:comm:thunderbird:releng:bouncer:server:staging
  - project:comm:thunderbird:releng:bouncer:server:staging-nazgul
  - project:comm:thunderbird:releng:ship-it:action:mark-as-shipped
  - project:comm:thunderbird:releng:ship-it:action:mark-as-started
  - project:comm:thunderbird:releng:ship-it:server:staging
  - project:comm:thunderbird:releng:signing:cert:dep-signing
  - project:comm:thunderbird:releng:signing:format:*
  - project:comm:thunderbird:releng:treescript:action:push
  - project:comm:thunderbird:releng:treescript:action:tagging
  - project:comm:thunderbird:releng:treescript:action:version_bump
  - queue:create-task:low:scriptworker-prov-v1/tb-balrog-dev
  - queue:create-task:low:scriptworker-prov-v1/tb-beetmover-dev
  - queue:create-task:low:scriptworker-prov-v1/tb-bouncer-dev
  - queue:create-task:low:scriptworker-prov-v1/tb-depsigning
  - queue:create-task:low:scriptworker-prov-v1/tb-shipit-dev*
  - queue:create-task:low:scriptworker-prov-v1/tb-treescript-comm-dev
  - queue:create-task:low:scriptworker-prov-v1/tb-depsigning-mac-v1
  - secrets:get:project/comm/thunderbird/releng/build/level-1/*
  to:
  - projects:
      feature: gecko-roles
      level: [1, 2, 3]
      trust_domain: comm

# moz-tree:level:2:*
- grant:
  - docker-worker:capability:device:phone
  - docker-worker:image:taskclusterprivate/phone-builder:*
  - docker-worker:image:taskclusterprivate/tester-device:*
  - queue:create-task:aws-provisioner-v1/ami-test*
  - queue:create-task:dummy-test-provisioner/dummy-test-type
  - queue:create-task:gecko-t-tc-worker/*
  - queue:create-task:localprovisioner/*
  - queue:create-task:packetnet/*
  - queue:create-task:tc-worker-provisioner/*
  - queue:create-task:test-dummy-provisioner/*
  - queue:create-task:very-low:aws-provisioner-v1/ami-test*
  - queue:create-task:very-low:dummy-test-provisioner/dummy-test-type
  - queue:create-task:very-low:gecko-t-tc-worker/*
  - queue:create-task:very-low:localprovisioner/*
  - queue:create-task:very-low:packetnet/*
  - queue:create-task:very-low:tc-worker-provisioner/*
  - queue:create-task:very-low:test-dummy-provisioner/*
  - secrets:get:project/taskcluster/gecko/build/level-2/*
  to:
  - projects:
      feature: gecko-roles
      level: [2, 3]

# moz-tree:level:3:*
- grant:
  - auth:aws-s3:read-write:public-qemu-images/repository/hg.mozilla.org/mozilla-central/*
  - docker-worker:feature:balrogStageVPNProxy
  - docker-worker:feature:balrogVPNProxy
  - docker-worker:image:taskclusterprivate/taskcluster-vpn-proxy:*
  - project:releng:balrog:server:beta
  - project:releng:balrog:server:release
  - project:releng:balrog:server:esr
  - project:releng:beetmover:bucket:release
  - project:releng:ship-it:production
  - project:releng:googleplay:beta
  - queue:create-task:aws-provisioner-v1/ami-test*
  - queue:create-task:dummy-test-provisioner/dummy-test-type
  - queue:create-task:gecko-t-tc-worker/*
  - queue:create-task:highest:aws-provisioner-v1/ami-test*
  - queue:create-task:highest:dummy-test-provisioner/dummy-test-type
  - queue:create-task:highest:gecko-t-tc-worker/*
  - queue:create-task:highest:localprovisioner/*
  - queue:create-task:highest:null-provisioner/human-breakpoint
  - queue:create-task:highest:packetnet/*
  - queue:create-task:highest:scriptworker-prov-v1/dep-pushapk
  - queue:create-task:highest:scriptworker-prov-v1/pushapk-v1
  - queue:create-task:highest:scriptworker-prov-v1/dummy-worker-transpar
  - queue:create-task:highest:scriptworker-prov-v1/signing-linux-dev
  - queue:create-task:highest:tc-worker-provisioner/*
  - queue:create-task:highest:test-dummy-provisioner/*
  - queue:create-task:localprovisioner/*
  - queue:create-task:packetnet/*
  - queue:create-task:tc-worker-provisioner/*
  - queue:create-task:test-dummy-provisioner/*
  - secrets:get:project/releng/snapcraft/firefox/edge
  - secrets:get:project/taskcluster/gecko/build/level-3/*
  to:
  - projects:
      feature: gecko-roles
      level: [3]

# moz-tree:level:3:gecko
- grant:
  - auth:aws-s3:read-write:tc-gp-private-1d-us-east-1/releng/mbsdiff-cache/
  - project:releng:addons.mozilla.org:server:production
  - project:releng:beetmover:action:push-to-maven
  - project:releng:beetmover:action:push-to-partner
  - project:releng:beetmover:bucket:maven-production
  - project:releng:beetmover:bucket:partner
  - project:releng:bouncer:server:production
  - project:releng:bouncer:server:production-nazgul
  - project:releng:googleplay:release
  - project:releng:ship-it:action:mark-as-shipped
  - project:releng:ship-it:action:mark-as-started
  - project:releng:ship-it:server:production
  - project:releng:ship-it:server:staging
  - project:releng:signing:cert:nightly-signing
  - project:releng:signing:cert:release-signing
  - project:releng:snapcraft:firefox:beta
  - project:releng:snapcraft:firefox:candidate
  - project:releng:snapcraft:firefox:esr
  - queue:create-task:highest:aws-provisioner-v1/taskcluster-generic
  - queue:create-task:highest:proj-autophone/*
  - queue:create-task:highest:scriptworker-prov-v1/addon-v1
  - queue:create-task:highest:scriptworker-prov-v1/balrogworker-v1
  - queue:create-task:highest:scriptworker-prov-v1/beetmoverworker-v1
  - queue:create-task:highest:scriptworker-prov-v1/bouncer-dev
  - queue:create-task:highest:scriptworker-prov-v1/bouncer-v1
  - queue:create-task:highest:scriptworker-prov-v1/depsigning
  - queue:create-task:highest:scriptworker-prov-v1/depsigning-mac-v1
  - queue:create-task:highest:scriptworker-prov-v1/pushsnap-v1
  - queue:create-task:highest:scriptworker-prov-v1/shipit-dev*
  - queue:create-task:highest:scriptworker-prov-v1/shipit-v1
  - queue:create-task:highest:scriptworker-prov-v1/signing-linux-v1
  - queue:create-task:highest:scriptworker-prov-v1/treescript-v1
  - queue:create-task:highest:scriptworker-prov-v1/signing-mac-v1
  - queue:route:index.gecko.heavyprofile.*
  - queue:route:notify.email.release+tcstaging@mozilla.com.
  - queue:route:notify.email.release-automation-notifications@mozilla.com.*
  - secrets:get:project/releng/snapcraft/firefox/candidate
  to:
  - projects:
      feature: gecko-roles
      level: [3]
      trust_domain: gecko

# moz-tree:level:3:comm
- grant:
  - queue:create-task:highest:scriptworker-prov-v1/tb-balrog-dev
  - queue:create-task:highest:scriptworker-prov-v1/tb-beetmover-dev
  - queue:create-task:highest:scriptworker-prov-v1/tb-depsigning
  - queue:create-task:highest:scriptworker-prov-v1/tb-depsigning-mac-v1
  - queue:create-task:highest:scriptworker-prov-v1/tb-signing-v1
  - queue:create-task:highest:scriptworker-prov-v1/tb-signing-mac-v1
  - secrets:get:project/comm/thunderbird/releng/build/level-3/*
  to:
  - projects:
      feature: gecko-roles
      level: [3]
      trust_domain: comm

# tooltool downloads
- grant:
  - docker-worker:relengapi-proxy:tooltool.download.internal
  - docker-worker:relengapi-proxy:tooltool.download.public
  - project:releng:services/tooltool/api/download/internal
  - project:releng:services/tooltool/api/download/public
  # This cache contains cached downloads from tooltool.  Since tooltool is
  # content-addressible, and verifies hashes on files in the cache, there is no
  # risk of cache poisoning or collisions.
  - docker-worker:cache:tooltool-cache
  to:
  - projects:
      feature: gecko-roles
      level: [1, 2, 3]

##
# project-specific scopes (for esr's to hang onto their old scopes)

- grant:
  - project:comm:thunderbird:releng:balrog:server:release
  to:
  - project:
      alias: [comm-esr60, comm-esr68]

- grant:
  - project:comm:thunderbird:releng:balrog:server:beta
  to:
  - project:
      alias: comm-beta

- grant:
  - project:comm:thunderbird:releng:signing:cert:nightly-signing
  to:
  - project:
      alias: comm-central

- grant:
  - project:comm:thunderbird:releng:beetmover:bucket:release
  - project:comm:thunderbird:releng:bouncer:server:production
  - project:comm:thunderbird:releng:bouncer:server:production-nazgul
  - project:comm:thunderbird:releng:ship-it:server:production
  - project:comm:thunderbird:releng:signing:cert:release-signing
  - queue:create-task:highest:scriptworker-prov-v1/tb-balrog-v1
  - queue:create-task:highest:scriptworker-prov-v1/tb-beetmover-v1
  - queue:create-task:highest:scriptworker-prov-v1/tb-bouncer-v1
  - queue:create-task:highest:scriptworker-prov-v1/tb-shipit-v1
  - queue:create-task:highest:scriptworker-prov-v1/tb-signing-v1
  - queue:create-task:highest:scriptworker-prov-v1/tb-treescript-comm-v1
  to:
  - project:
      alias: [comm-esr60, comm-esr68, comm-beta]

- grant:
  - project:releng:beetmover:bucket:nightly
  - project:releng:balrog:server:nightly
  to:
  - project:
      alias: oak

- grant:
  # Bug 1527818: Coverity configuration is stored in this secret
  - secrets:get:project/relman/coverity
  # Bug 1527818: Coverity license is stored in this secret
  # It should not be widely available
  - secrets:get:project/relman/coverity-license
  # Bug 1523321: Token for mirroring webrender to github
  - secrets:get:project/webrender-ci/wrupdater-github-token
  to:
  - project:
      alias: mozilla-central

- grant:
  # Bug 1530376: Add scopes for Code Review bot in CI
  - queue:route:project.relman.codereview.*
  # Bug 1541147: Coverity configuration is stored in this secret
  - secrets:get:project/relman/coverity
  to:
  - project:
      alias: try

##
# Non-gecko tree projects

- grant:
  - docker-worker:feature:allowPtrace
  - queue:create-task:aws-provisioner-v1/hg-worker
  - queue:create-task:aws-provisioner-v1/nss-win2012r2
  - queue:create-task:localprovisioner/nss-aarch64
  - queue:create-task:localprovisioner/nss-macos-10-12
  - queue:create-task:localprovisioner/nss-rpi
  - queue:route:index.docker.images.v1.nss.*
  to:
  - project:
      alias: nss

- grant:
  - docker-worker:feature:allowPtrace
  - queue:create-task:aws-provisioner-v1/ami-test-win2012r2
  - queue:create-task:aws-provisioner-v1/gecko-1-b-win*
  - queue:create-task:aws-provisioner-v1/hg-worker
  - queue:create-task:aws-provisioner-v1/nss-*
  - queue:create-task:aws-provisioner-v1/win2012r2
  - queue:create-task:gecko-1/win*
  - queue:create-task:localprovisioner/nss-aarch64
  - queue:create-task:localprovisioner/nss-macos-10-12
  - queue:route:index.docker.images.v1.nss-try.*
  - queue:route:project.relman.codereview.*
  - secrets:get:project/relman/coverity-nss
  to:
  - project:
      alias: nss-try

- grant:
  # These are public
  - secrets:get:project/taskcluster/gecko/hgfingerprint
  - secrets:get:project/taskcluster/gecko/hgmointernal

  # Allow a sensible scheduler-id
  - queue:scheduler-id:{trust_domain}-level-{level}
  # Allows cancelling tasks with that scheduler-id
  - queue:cancel-task:{trust_domain}-level-{level}/*
  # Allow reruning tasks with that scheduler-id
  - queue:rerun-task:{trust_domain}-level-{level}/*

  # routes to support indexing by product
  - queue:route:index.{trust_domain}.v2.{alias}.*
  - index:insert-task:{trust_domain}.v2.{alias}.*

  # Allow creating tasks on workers associated to the trust-domain
  - queue:create-task:{priority}:{trust_domain}-{level}/*
  - queue:create-task:{priority}:{trust_domain}-t/*

  # routes to support locating tasks that create specific versions of artifacts
  # (toolchains, etc.)
  - queue:route:index.{trust_domain}.cache.level-{level}.*
  - index:insert-task:{trust_domain}.cache.level-{level}.*

  # allow fetching secrets appropriate to this level
  - secrets:get:project/releng/{trust_domain}/build/level-{level}/*

  # allow using worker caches appropriate to this trust domain and level
  - docker-worker:cache:{trust_domain}-level-{level}-*
  - generic-worker:cache:{trust_domain}-level-{level}-*
  to:
  - project:
      feature: trust-domain-scopes

- grant:
  # routes to support reporting to treeherder
  - queue:route:tc-treeherder-stage.{alias}.*
  - queue:route:tc-treeherder.{alias}.*
  - queue:route:tc-treeherder-stage.v2.{alias}.*
  - queue:route:tc-treeherder.v2.{alias}.*
  to:
  - project:
      feature: treeherder-reporting


- grant:
  - queue:create-task:aws-provisioner-v1/version-control-tools
  - queue:route:notify.irc-channel.*
  - queue:route:tc-treeherder.v2.version-control-tools.*
  to:
  - project:
      alias: version-control-tools

- grant:
  - queue:create-task:low:aws-provisioner-v1/gecko-{level}-decision
  - queue:create-task:low:aws-provisioner-v1/gecko-misc
  - queue:create-task:low:aws-provisioner-v1/gecko-{level}-images
  to:
  - project:
      trust_domain: [taskgraph, ci]

##
# feature-specific roles

- grant:
  - queue:route:index.{trust_domain}.v2.trunk.revision.*
  to:
  - project:
      feature: is-trunk

##
# mozilla roles
#
# Mind yourself of globstar roles such as the following that could potentially
# grant even more scopes to certain roles in an automatic way
# > https://tools.taskcluster.net/auth/roles/repo%3A*
# > https://tools.taskcluster.net/auth/roles/repo%3Agithub.com%2F*
# > https://tools.taskcluster.net/auth/roles/repo%3Agithub.com%2Fmozilla%2F*

# - application-services specific roles
- grant:
  - assume:project:taskcluster:mozilla-github-repository
  - docker-worker:taskcluster-proxy:tooltool.download.internal
  - project:releng:services/tooltool/api/download/internal
  - queue:route:index.project.application-services.*
  - queue:create-task:highest:aws-provisioner-v1/app-services-{level}-*
  - docker-worker:cache:application-services-*
  to:
  - project:
      alias: application-services
      job: ["pull-request", "branch:master", "release"]

- grant:
  - project:mozilla:{alias}:releng:beetmover:action:push-to-maven
  - project:mozilla:{alias}:releng:beetmover:bucket:maven-production
  - project:mozilla:{alias}:releng:signing:cert:release-signing
  - queue:create-task:highest:scriptworker-prov-v1/appsv-beetmover-v1
  - queue:create-task:scriptworker-prov-v1/appsv-signing-v1
  - secrets:get:project/application-services/gradle-plugin-publish
  - secrets:get:project/application-services/publish
  - secrets:get:project/application-services/symbols-token
  to:
  - project:
      alias: application-services
      job: ["release"]

# - balrog specific roles
- grant:
  - secrets:get:repo:github.com/mozilla/balrog:coveralls
  to:
  - project:
      alias: balrog
      job: ["pull-request", "branch:master"]

- grant:
  - queue:route:index.project.balrog.*
  - queue:route:notify.*
  - secrets:get:repo:github.com/mozilla/balrog:dockerhub
  to:
  - project:
      alias: balrog
      job: ["branch:master"]

- grant:
  - queue:route:index.project.balrog.*
  - secrets:get:repo:github.com/mozilla/balrog:dockerhub
  # S3 creds are for deploying the UI
  - secrets:get:repo:github.com/mozilla/balrog:s3-prod-app-config
  - secrets:get:repo:github.com/mozilla/balrog:s3-prod-aws-creds
  - secrets:get:repo:github.com/mozilla/balrog:s3-stage-app-config
  - secrets:get:repo:github.com/mozilla/balrog:s3-stage-aws-creds
  to:
  - project:
      alias: balrog
      job: ["release"]

##
# mozilla-releng roles
#
# Mind yourself of globstar roles such as the following that could potentially
# grant even more scopes to certain roles in an automatic way
# > https://tools.taskcluster.net/auth/roles/repo%3A*
# > https://tools.taskcluster.net/auth/roles/repo%3Agithub.com%2F*
# > https://tools.taskcluster.net/auth/roles/repo%3Agithub.com%2Fmozilla-releng%2F*

# - k8s-autoscale roles
- grant:
  - secrets:get:project/releng/k8s-autoscale/deploy
  to:
  - project:
      alias: k8s-autoscale
      job: ["branch:master", "branch:production"]

# - product-details specific roles
- grant:
  - secrets:get:repo:github.com/mozilla-releng/product-details:branch:production
  to:
  - projects:
      alias: product-details
      job: ["branch:production"]

- grant:
  - secrets:get:repo:github.com/mozilla-releng/product-details:branch:staging
  to:
  - projects:
      alias: product-details
      job: ["branch:staging"]

- grant:
  - secrets:get:repo:github.com/mozilla-releng/product-details:branch:testing
  to:
  - projects:
      alias: product-details
      job: ["branch:testing"]

# - scriptworker-scripts specific roles
- grant:
  - secrets:get:project/releng/scriptworker-scripts/deploy
  to:
  - projects:
      alias: scriptworker-scripts
      job: ["branch:production*", "branch:dev*"]

# - shipit specific roles
- grant:
  - secrets:get:project/releng/shipit/deploy
  to:
  - projects:
      alias: shipit
      job: ["branch:testing", "branch:staging", "branch:production"]

# - tooltool specific roles
- grant:
  - secrets:get:project/releng/tooltool/ci
  to:
  - projects:
      alias: tooltool
      job: ["branch:*", "pull-request"]

- grant:
  - secrets:get:project/releng/tooltool/deploy
  to:
  - projects:
      alias: tooltool
      job: ["branch:*"]

##
# mobile-specific roles
#
# We refer to level 1 as the staging/development workflow for a given project
# (e.g. pull/requests and staging-triggered releases) while level 3 defines the
# production releases (Github-based releases or triggered via hooks)
#
# Mind yourself of globstar roles such as the following that could potentially
# grant even more scopes to certain roles in an automatic way
# > https://tools.taskcluster.net/auth/roles/repo%3A*
# > https://tools.taskcluster.net/auth/roles/repo%3Agithub.com%2F*
# > https://tools.taskcluster.net/auth/roles/repo%3Agithub.com%2Fmozilla-mobile%2F*

# mobile:level:X:*
- grant:
  - assume:project:taskcluster:mozilla-github-repository
  - queue:create-task:highest:aws-provisioner-v1/mobile-{level}-*
  - queue:create-task:highest:mobile-{level}/*
  - queue:create-task:highest:mobile-t/*
  - queue:create-task:{priority}:built-in/*
  - queue:route:index.project.mobile.{alias}.cache.level-{level}.*
  - project:mobile:{alias}:releng:signing:cert:dep-signing
  - project:mobile:{alias}:releng:signing:format:*
  - queue:create-task:highest:scriptworker-prov-v1/mobile-signing-dep-v1
  - queue:route:index.project.mobile.{alias}.staging-signed-nightly.*
  - queue:route:index.project.mobile.{alias}.v2.staging.*
  - queue:route:index.project.mobile.{alias}.v3.staging.*
  to:
  - project:
      feature: mobile-roles
      job: ["pull-request", "branch:*", "branch:master", "release", "cron:*"]

- grant:
  - queue:route:index.project.mobile.{alias}.v3.debug.*
  to:
  - project:
      feature: mobile-roles
      job: ["branch:master", "release", "cron:*"]

- grant:
  - queue:create-task:highest:aws-provisioner-v1/mobile-3-*
  - queue:route:statuses
  - queue:create-task:highest:aws-provisioner-v1/github-worker
  to:
  - project:
      feature: mobile-roles
      job: ["cron:nightly"]

- grant:
  - queue:create-task:highest:aws-provisioner-v1/mobile-1-*
  - queue:route:statuses
  - queue:create-task:highest:aws-provisioner-v1/github-worker
  to:
  - project:
      feature: mobile-roles
      job: ["cron:nightly-staging"]

- grant:
  - queue:route:index.project.mobile.{alias}.branch.master.*
  - queue:route:index.project.mobile.{alias}.v2.branch.master.*
  to:
  - project:
      feature: mobile-roles
      job: ["branch:master"]

- grant:
  - assume:project:taskcluster:mozilla-github-repository
  - queue:create-task:highest:aws-provisioner-v1/mobile-{level}-*
  to:
  - project:
      feature: mobile-roles-forks
      # We don't want pull requests on forks
      job: ["branch:*"]

- grant:
  - project:mobile:{alias}:releng:beetmover:action:push-to-maven
  - project:mobile:{alias}:releng:beetmover:bucket:maven-production
  - queue:create-task:highest:scriptworker-prov-v1/mobile-beetmover-v1
  to:
  - project:
      feature: mobile-beetmover-phase
      job: ["release"]

- grant:
  - project:mobile:{alias}:releng:beetmover:action:push-to-maven
  - project:mobile:{alias}:releng:beetmover:bucket:maven-snapshot-production
  - queue:create-task:highest:scriptworker-prov-v1/mobile-beetmover-v1
  to:
  - project:
      feature: mobile-beetmover-snapshot-phase
      job: ["cron:snapshot"]

- grant:
  - project:mobile:{alias}:releng:signing:cert:release-signing
  - queue:create-task:highest:scriptworker-prov-v1/mobile-signing-v1
  - queue:route:index.project.mobile.{alias}.signed-nightly.*
  - queue:route:index.project.mobile.{alias}.v2.nightly.*
  to:
  - project:
      feature: mobile-sign-phase
      job: ["release", "cron:nightly"]

- grant:
  - project:mobile:{alias}:releng:signing:cert:release-signing
  - queue:create-task:highest:scriptworker-prov-v1/mobile-signing-v1
  to:
  - project:
      alias: android-components
      job: ["release", "cron:snapshot"]

- grant:
  - project:mobile:{alias}:releng:googleplay:product:{alias}
  - queue:create-task:highest:scriptworker-prov-v1/mobile-pushapk-v1
  to:
  - project:
      feature: mobile-pushapk-phase
      job: ["release", "cron:nightly"]

- grant:
  - project:mobile:{alias}:releng:googleplay:product:{alias}:dep
  - queue:create-task:highest:scriptworker-prov-v1/mobile-pushapk-dep-v1
  to:
  - project:
      feature: mobile-pushapk-stage-phase
      job: ["cron:nightly-staging"]

# android-components specific scopes
- grant:
  - secrets:get:project/mobile/android-components/public-tokens
  to:
  - project:
      alias: android-components
      job: ["pull-request", "branch:*", "branch:master"]

- grant:
  - secrets:get:project/mobile/android-components/firebase
  to:
  - projects:
      alias: android-components
      job: ["branch:*"]


# TODO: Once bug 1519493 is completed, we will be able to assign staging vs
# production scopes to various sub-roles. Until then, this is a temp solution
- grant:
  - project:mobile:{alias}:releng:signing:cert:dep-signing
  # TODO Refactor the following 2 scopes into one. The second one is the fenix one.
  # Thanks to the {alias} prefix, reference-browser can't sign APKs with the Fenix key,
  # nor the other way around.
  - queue:create-task:highest:scriptworker-prov-v1/mobile-signing-dep-v1
  - queue:create-task:highest:proj-autophone/gecko-t-ap-perf-g5
  - queue:create-task:highest:proj-autophone/gecko-t-ap-perf-p2
  - queue:create-task:highest:proj-autophone/gecko-t-bitbar-gw-perf-g5
  - queue:create-task:highest:proj-autophone/gecko-t-bitbar-gw-perf-p2
  - queue:route:notify.email.perftest-alerts@mozilla.com.on-failed
  to:
  - project:
      feature: autophone
      # PRs are temporarily allowed to test the integration of Raptor
      job: ["branch:master", "cron:raptor", "pull-request"]


- grant:
  - queue:route:index.project.mobile.{alias}.v3.raptor.*
  - queue:route:index.project.mobile.{alias}.v2.performance-test.*
  to:
  - project:
      feature: autophone
      job: ["branch:master", "cron:raptor"]

# fenix specific scopes
- grant:
  - queue:route:index.project.fenix.android.preview-builds
  - github:create-comment:mozilla-mobile/fenix
  to:
  - project:
      alias: fenix
      job: ["pull-request"]

- grant:
  - secrets:get:project/mobile/fenix/public-tokens
  # Fenix PRs are now restricted to collaborators, so exposing firebase is safe-enough
  - secrets:get:project/mobile/fenix/firebase
  to:
  - project:
      alias: fenix
      job: ["branch:master", "branch:*", "pull-request"]

# TODO: Once bug 1519493 is completed, we will be able to assign staging vs
# production scopes to various sub-roles. Until then, this is a temp solution
- grant:
  - project:mobile:fenix:releng:signing:cert:dep-signing
  - queue:create-task:highest:scriptworker-prov-v1/mobile-signing-dep-v1
  to:
  - project:
      alias: fenix
      job: ["branch:master"]

- grant:
  - project:mobile:fenix:releng:signing:cert:*
  - queue:route:index.project.mobile.fenix.v2.*
  - secrets:get:project/mobile/fenix/beta
  - secrets:get:project/mobile/fenix/production
  to:
  - project:
      alias: fenix
      job: ["release"]

# TODO: at some point we should move out the beta related scopes from the nightly hook
- grant:
  # FIXME: to be removed later on as it's a duplicate with `product:fenix` counterpart
  - project:mobile:fenix:releng:googleplay:product:fenix:nightly
  # FIXME: to be removed later on as it's a duplicate with `cert:release-signing` counterpart
  - project:mobile:fenix:releng:signing:cert:nightly-signing
  - queue:route:index.project.mobile.fenix.v2.beta.*
  - secrets:get:project/mobile/fenix/nightly
  # FIXME: remove "nightlyLegacy" scope when this issue is fixed: https://github.com/mozilla-mobile/fenix/issues/4873
  - secrets:get:project/mobile/fenix/nightlyLegacy
  # FIXME: remove nightly-legacy scope when the "nightly" track of "org.mozilla.fenix" is discontinued
  - secrets:get:project/mobile/fenix/nightly-legacy
  - secrets:get:project/mobile/fenix/fennec-production
  - secrets:get:project/mobile/fenix/nimbledroid
  - queue:route:notify.email.fenix-eng-notifications@mozilla.com.on-failed

  # FIXME: For legacy reasons, Fenix Nightly is being deployed to the Fenix Production app, and requires Production scopes
  - project:mobile:fenix:releng:signing:cert:production-signing

  # XXX We want Fenix to replace Fennec release at some point
  - project:mobile:fenix:releng:signing:cert:fennec-production-signing
  - queue:route:index.project.mobile.fenix.v2.fennec-production.*
  to:
  - project:
      alias: fenix
      job: ["cron:nightly"]

- grant:
  - queue:route:index.project.mobile.fenix.v2.staging.*
  - secrets:get:garbage/staging/project/mobile/fenix
  to:
  - project:
      alias: fenix
      job: ["cron:nightly-staging"]

- grant:
  - queue:scheduler-id:{trust_domain}-level-{level}
  # allow using worker caches appropriate to this trust domain and level
  - docker-worker:cache:{trust_domain}-level-{level}-*
  - generic-worker:cache:{trust_domain}-level-{level}-*
  to:
  - project:
      feature: mobile-taskgraph
      job: ["pull-request", "branch:*", "branch:master", "release", "cron:*"]

# reference-browser specific scopes
- grant:
  - queue:route:index.project.mobile.reference-browser.v3.nightly.*
  - queue:route:index.project.mobile.reference-browser.v3.signed-nightly.*
  - secrets:get:project/mobile/reference-browser/nimbledroid
  - secrets:get:project/mobile/reference-browser/sentry
  - queue:route:notify.email.android-components-team@mozilla.com.on-failed
  to:
  - project:
      alias: reference-browser
      job: ["cron:nightly"]

- grant:
  - secrets:get:garbage/staging/project/mobile/reference-browser/nimbledroid
  - secrets:get:garbage/staging/project/mobile/reference-browser/sentry
  - secrets:get:project/mobile/reference-browser/nimbledroid
  to:
  - project:
      alias: reference-browser
      job: ["cron:nightly-staging"]

# focus-android scopes
- grant:
    - queue:route:notify.irc-channel.#android-ci.on-any
    - secrets:get:project/focus/firebase
    - secrets:get:project/focus/nimbledroid
  to:
  - project:
      alias: focus-android
      job: ["branch:*"]

- grant:
    - project:mobile:focus:releng:googleplay:product:focus
    - project:mobile:focus:releng:signing:cert:release-signing
    - project:mobile:focus:releng:signing:format:autograph_focus
    - project:mobile:focus:releng:signing:format:focus-jar
    - queue:route:index.project.mobile.focus.release.latest
    - secrets:get:project/focus/firebase
    - secrets:get:project/focus/nimbledroid
    - secrets:get:project/focus/tokens
  to:
  - project:
      alias: focus-android
      job: ["release"]

# firefox-tv specific scopes
- grant:
  - secrets:get:project/mobile/firefox-tv/tokens
  to:
  - project:
      alias: firefox-tv
      job: ["branch:*", "pull-request", "release"]

- grant:
  - notify:email:firefox-tv@mozilla.com
  - project:mobile:firefox-tv:releng:signing:cert:production-signing
  to:
  - project:
      alias: firefox-tv
      job: ["release"]

# L10n repositories
- grant:
  - queue:create-task:highest:aws-provisioner-v1/l10n-{level}-*
  - queue:create-task:{priority}:built-in/*
  - queue:route:index.{trust_domain}.{alias}.cache.level-{level}.*
  - queue:scheduler-id:{trust_domain}-level-{level}
  - docker-worker:cache:{trust_domain}-level-{level}-*
  - generic-worker:cache:{trust_domain}-level-{level}-*
  - queue:route:notify.email.*
  - queue:route:checks
  to:
  - project:
      alias:
      - android-l10n-tooling
      job: ["pull-request", "branch:*", "cron:*"]

- grant:
  - secrets:get:l10n/level-{level}/*
  to:
  - project:
      alias:
      - android-l10n-tooling
      job: ["branch:*", "cron:*"]


# MPD001

- grant:
  - queue:create-task:highest:aws-provisioner-v1/{trust_domain}-{level}-*
  - queue:create-task:{priority}:built-in/*
  - queue:route:index.{trust_domain}.cache.level-{level}.*
  - queue:scheduler-id:{trust_domain}-level-{level}
  - docker-worker:cache:{trust_domain}-level-{level}-*
  - generic-worker:cache:{trust_domain}-level-{level}-*
  - queue:route:notify.email.*
  - queue:route:checks
  - queue:get-artifact:project/mpd001/*
  - project:mpd001:releng:signing:format:sha2signcode
  - project:mpd001:releng:signing:format:autograph_authenticode
  # Temporary until windows workers use mpd001
  - queue:create-task:highest:aws-provisioner-v1/mpd-{level}-*
  # Temporary secret for cloning; this should be renamed
  - secrets:get:project/releng/callek/mpd001-deploykey
  # Create level-1 scopes explicitly
  - queue:create-task:highest:aws-provisioner-v1/{trust_domain}-1-*
  - queue:route:index.{trust_domain}.cache.level-1.*
  - queue:scheduler-id:{trust_domain}-level-1
  - docker-worker:cache:{trust_domain}-level-1-*
  - generic-worker:cache:{trust_domain}-level-1-*
  to:
  - project:
      alias:
      - mpd001
      job: ["pull-request", "branch:*", "cron:*"]

- grant:
  - queue:create-task:highest:scriptworker-k8s/{trust_domain}-{level}-*
  - queue:create-task:highest:scriptworker-prov-v1/{trust_domain}-{level}-*
  - queue:create-task:highest:scriptworker-k8s/{trust_domain}-1-*
  - queue:create-task:highest:scriptworker-prov-v1/{trust_domain}-1-*
  - project:mpd001:releng:signing:cert:dep-signing
  to:
  - project:
      alias:
      - mpd001
      # Only enable this for master and pull-requests, so that in-repo branches
      # don't get access to scriptworkers.
      job:
        - "branch:master"
        - "pull-request"
        - "branch:callek-branch-of-tom"
        - "branch:releng-develop"
        - "branch:releng-release"
        - "branch:release"

- grant:
  - project:mpd001:releng:signing:cert:release-signing
  to:
  - project:
      alias:
      - mpd001
      # Only enable this for master and pull-requests, so that in-repo branches
      # don't get access to scriptworkers.
      job:
        - "branch:master"
        - "branch:releng-release"
        - "branch:release"

# XPI

- grant:
  - queue:create-task:highest:scriptworker-k8s/{trust_domain}-t-*
  - queue:create-task:highest:scriptworker-prov-v1/{trust_domain}-t-*
  - project:xpi:releng:signing:cert:dep-signing
  - project:xpi:releng:signing:cert:release-signing
  - queue:create-task:highest:xpi-{level}/*
  - queue:create-task:highest:xpi-t/*
  - queue:create-task:highest:aws-provisioner-v1/{trust_domain}-t-*
  - queue:create-task:highest:aws-provisioner-v1/{trust_domain}-{level}-*
  - queue:create-task:highest:scriptworker-k8s/{trust_domain}-{level}-*
  - queue:create-task:highest:scriptworker-k8s/{trust_domain}-t-*
  - queue:create-task:highest:scriptworker-prov-v1/{trust_domain}-{level}-*
  - queue:create-task:highest:scriptworker-prov-v1/{trust_domain}-t-*
  to:
  - project:
      alias:
      - xpi-manifest
      # Only enable this for master and actions.
      job: ["branch:master", "action:*"]

- grant:
  # access to workers; all levels have access to the same workers, but at
  # different priorities and levels
  - queue:route:index.{trust_domain}.xpi-manifest.cache.level-{level}.*
  - queue:route:index.{trust_domain}.v2.{alias}.*
  - queue:route:checks
  - queue:route:notify.email.*
  - queue:route:tc-treeherder.v2.{alias}.*
  - queue:create-task:{priority}:built-in/*
  - queue:create-task:{priority}:xpi-{level}/*
  - queue:create-task:{priority}:xpi-t/*
  - queue:create-task:{priority}:aws-provisioner-v1/{trust_domain}-t-*
  - queue:create-task:{priority}:aws-provisioner-v1/{trust_domain}-{level}-*
  - queue:getArtifact:xpi/*
  - queue:scheduler-id:{trust_domain}-level-{level}
  - docker-worker:cache:{trust_domain}-level-{level}-*
  - secrets:get:project/xpi/xpi-github-clone-ssh
  to:
  - project:
      feature: xpi-roles
      job: ["pull-request", "branch:*", "cron:*", "action:*"]

- grant:
  - in-tree:hook-action:project-{trust_domain}/in-tree-action-{level}-*
  to:
  - project:
      feature: taskgraph-actions
      job: branch:master

##
# delegate cron:nightly-* to hand-managed nightly roles

- grant:
  - assume:project:releng:nightly:level-{level}:{alias}
  to:
  - project:
      feature: gecko-cron
      trust_domain: gecko
      job: cron:nightly-*

- grant:
  - assume:project:comm:thunderbird:comm:releng:nightly:level-{level}:{alias}
  to:
  - project:
      feature: gecko-cron
      trust_domain: comm
      job: cron:nightly-*

- grant:
  - project:releng:beetmover:bucket:maven-production
  - project:releng:beetmover:action:push-to-maven
  to:
  - project:
      alias:
        - mozilla-central
        - mozilla-beta
        - mozilla-release
      job: cron:ship-geckoview

##
# Administrative Scopes

- grant:
  # Allow sherrifs to quarantine gecko related workers
  - queue:quarantine-worker:aws-provisioner-v1/gecko-*
  - queue:quarantine-worker:bitbar/gecko-*
  - queue:quarantine-worker:gecko-1/*
  - queue:quarantine-worker:gecko-3/*
  - queue:quarantine-worker:gecko-t/*
  - queue:quarantine-worker:proj-autophone/gecko-*
  - queue:quarantine-worker:releng-hardware/gecko-*
  - queue:quarantine-worker:terraform-packet/gecko-*
  # Allow sherrifs to terminate gecko related workers
  - worker-manager:remove-worker:gecko-*
  # Allow sherrifs to rerun and cancel gecko tasks
  # Allows cancelling tasks with that scheduler-id
  - queue:cancel-task:gecko-level-*
  - queue:rerun-task:gecko-level-*
  # Allow managing treestatus
  - assume:project:releng:treestatus/admin
  # Allow triggering nightlies and geckoview
  - hooks:trigger-hook:project-releng/cron-task-releases-mozilla-beta/ship-geckoview
  - hooks:trigger-hook:project-releng/cron-task-releases-mozilla-release/ship-geckoview
  - hooks:trigger-hook:project-releng/cron-task-releases-mozilla-esr68/nightly-*
  - hooks:trigger-hook:project-releng/cron-task-mozilla-central/nightly-*
  - hooks:trigger-hook:project-releng/cron-task-mozilla-central/ship-geckoview
  to:
  - groups:
    - sheriff

- grant:
  - aws-provisioner:manage-worker-type:gecko-*
  - ec2-manager:manage-instances:*
  - ec2-manager:manage-resources:*
  to:
  - groups:
    - sheriff
  environments:
    - legacy

- grant:
  # Allow people with level-3 access to access interactive tasks
  - queue:get-artifact:private/interactive/*
  - queue:get-artifact:private/docker-worker/*
  to:
  - groups:
    - active_scm_level_3

- grant:
  # Additional permissions for thunderbird-releng on comm level 3 tasks
  # Allow cancel
  - queue:cancel-task:comm-level-3/*
  # Allow rerun
  - queue:rerun-task:comm-level-3/*
  to:
  - groups:
    - thunderbird-releng


##
# hook scopes

# this scope is included in the decision task's .scopes, and indicates which
# in-tree action hooks may be triggered for the taskgroup. We use this to limit
# the actions on a taskgraph to those at the appropriate level, preventing
# someone with level-3 access from being tricked into running a level-3 hook on
# a level-1 (try) push.
- grant:
  - in-tree:hook-action:project-{trust_domain}/in-tree-action-{level}-*
  to:
  - project:
      feature: gecko-actions
      job: branch:default

# control who can run generic actions: basically anyone at the project's
# level or higher.
- grant:
  - hooks:trigger-hook:project-gecko/in-tree-action-1-generic/*
  - hooks:trigger-hook:project-comm/in-tree-action-1-generic/*
  to:
  - groups:
    - active_scm_level_1
    - active_scm_level_2
    - active_scm_level_3

- grant:
  - hooks:trigger-hook:project-gecko/in-tree-action-2-generic/*
  - hooks:trigger-hook:project-comm/in-tree-action-2-generic/*
  to:
  - groups:
    - active_scm_level_2
    - active_scm_level_3

- grant:
  - hooks:trigger-hook:project-gecko/in-tree-action-3-generic/*
  - hooks:trigger-hook:project-comm/in-tree-action-3-generic/*
  to:
  - groups:
    - active_scm_level_3

# retriggering a decision requires a lot of scopes, so only sheriffs
# and releng can do it
- grant:
  - hooks:trigger-hook:project-gecko/in-tree-action-1-retrigger-decision/*
  - hooks:trigger-hook:project-comm/in-tree-action-1-retrigger-decision/*
  - hooks:trigger-hook:project-gecko/in-tree-action-2-retrigger-decision/*
  - hooks:trigger-hook:project-comm/in-tree-action-2-retrigger-decision/*
  - hooks:trigger-hook:project-gecko/in-tree-action-3-retrigger-decision/*
  - hooks:trigger-hook:project-comm/in-tree-action-3-retrigger-decision/*
  to:
  - groups:
    - sheriff

# In addition to the default scopes, retriggering a decision task requires
# the scopes of a decision task.  These differ per project, so we use some
# substitution to generate the correct values
- grant:
  - assume:repo:hg.mozilla.org/{repo_path}:branch:default
  - in-tree:hook-action:project-gecko/in-tree-action-{level}-*
  to:
  - projects:
      feature: gecko-actions
      job: action:retrigger-decision

# Similarly with purging caches
- grant:
  - hooks:trigger-hook:project-gecko/in-tree-action-1-purge-caches/*
  - hooks:trigger-hook:project-comm/in-tree-action-1-purge-caches/*
  - hooks:trigger-hook:project-gecko/in-tree-action-2-purge-caches/*
  - hooks:trigger-hook:project-comm/in-tree-action-2-purge-caches/*
  - hooks:trigger-hook:project-gecko/in-tree-action-3-purge-caches/*
  - hooks:trigger-hook:project-comm/in-tree-action-3-purge-caches/*
  to:
  - groups:
    - sheriff

# pretty much anyone can cancel-all at level 1 or 2, while only releng/sheriff
# can do so at level 3
- grant:
  - hooks:trigger-hook:project-gecko/in-tree-action-1-cancel-all/*
  - hooks:trigger-hook:project-comm/in-tree-action-1-cancel-all/*
  - hooks:trigger-hook:project-gecko/in-tree-action-2-cancel-all/*
  - hooks:trigger-hook:project-comm/in-tree-action-2-cancel-all/*
  to:
  - groups:
    - active_scm_level_1
    - active_scm_level_2
    - active_scm_level_3
    - sheriff

- grant:
  - hooks:trigger-hook:project-gecko/in-tree-action-3-cancel-all/*
  - hooks:trigger-hook:project-comm/in-tree-action-3-cancel-all/*
  to:
  - groups:
    - sheriff

# Thunderbird releng can only cancel-all on comm trees
- grant:
  - hooks:trigger-hook:project-comm/in-tree-action-3-cancel-all/*
  to:
  - groups:
    - thunderbird-releng

# release promotion is only available to relman/releng
- grant:
  - hooks:trigger-hook:project-gecko/in-tree-action-1-release-promotion/*
  - hooks:trigger-hook:project-comm/in-tree-action-1-release-promotion/*
  - hooks:trigger-hook:project-gecko/in-tree-action-2-release-promotion/*
  - hooks:trigger-hook:project-comm/in-tree-action-2-release-promotion/*
  - hooks:trigger-hook:project-gecko/in-tree-action-3-release-promotion/*
  - hooks:trigger-hook:project-comm/in-tree-action-3-release-promotion/*
  to:
  - groups:
    - vpn_releasemgt

# tooltool.mozilla-releng.net and tokens.mozilla-releng.net scopes

- grant:
  - project:releng:services/tokens/api/usr/view/my
  - project:releng:services/tokens/api/usr/issue
  - project:releng:services/tokens/api/usr/revoke/my
  - project:releng:services/tokens/api/tmp/issue
  - project:releng:services/tooltool/api/download/public
  to:
  - groups:
    - active_scm_level_1
    - active_scm_level_2
    - active_scm_level_3
    - team_moco
    - tooltooleditor

- grant:
  - project:releng:services/tooltool/api/download/internal
  - project:releng:services/tooltool/api/download/public
  to:
  - groups:
    - team_moco

- grant:
  - project:releng:services/tooltool/api/upload/internal
  - project:releng:services/tooltool/api/upload/public
  to:
  - groups:
    - tooltooleditor

- grant:
  - secrets:get:project/comm/*
  - secrets:set:project/comm/*
  to:
  - groups: thunderbird-releng

# releng services hooks
- grant:
  - hooks:trigger-hook:project-releng/services-production-*
  - hooks:trigger-hook:project-releng/services-staging-*
  - hooks:trigger-hook:project-releng/services-testing-*
  to:
  - groups:
    - vpn_releasemgt


# Allow bitbar to manage bitbar workers
- grant:
  - assume:worker-type:bitbar/*
  - queue:worker-id:bitbar-*
  - auth:create-client:bitbar/*
  - auth:delete-client:bitbar/*
  - auth:disable-client:bitbar/*
  - auth:enable-client:bitbar/*
  - auth:reset-access-token:bitbar/*
  - auth:update-client:bitbar/*
  to:
  - groups:
    - bitbar

# Allow MozillaOnline to create builds
# See https://bugzilla.mozilla.org/show_bug.cgi?id=1515990
# This should also grant
#   assume:project-admin:mozillaonline
# but that currently creates a dependency cylce (Bug 1531166) so
# that scope is granted directly, along side this one.
- grant:
  # These are public
  - secrets:get:project/taskcluster/gecko/hgfingerprint
  - secrets:get:project/taskcluster/gecko/hgmointernal
  # Allow access to dedicated worker-types
  - queue:create-task:highest:aws-provisioner-v1/mozillaonline-1-*
  - queue:create-task:highest:aws-provisioner-v1/mozillaonline-3-*
  # Allow acceess scopes worker caches
  - docker-worker:cache:mozillaonline-level-1-*
  - docker-worker:cache:mozillaonline-level-3-*
  # Allow access to pacakged android sdk's from mozilla-central
  - queue:get-artifact:project/gecko/android-ndk/*
  - queue:get-artifact:project/gecko/android-sdk/*
  # Allow acess to API keys
  - secrets:get:project/releng/gecko/build/level-1/*
  # Allow access to public tooltool artifacts
  - docker-worker:relengapi-proxy:tooltool.download.public
  - project:releng:services/tooltool/api/download/public
  # Allow a sensible scheduler-id
  - queue:scheduler-id:mozillaonline-*
  # Allows cancelling tasks with that scheduler-id
  - queue:cancel-task:mozillaonline-*
  # Allow reruning tasks with that scheduler-id
  - queue:rerun-task:mozillaonline-*
  to:
  - groups:
    - mozillaonline

- grant:
  # Grant cloudops the ability to manage product-details secrets (Bug 1527571)
  - secrets:get:repo:github.com/mozilla-releng/product-details*
  - secrets:set:repo:github.com/mozilla-releng/product-details*
  to:
  - groups:
    - cloudops


- grant:
  # Grant mobile the ability to manually start release automation
  - hooks:trigger-hook:project-releng/cron-task-mozilla-mobile-fenix/nightly
  - hooks:trigger-hook:project-releng/cron-task-mozilla-mobile-android-components/snapshot
  - hooks:trigger-hook:project-releng/cron-task-releases-mozilla-beta/ship-geckoview
  - hooks:trigger-hook:project-releng/cron-task-releases-mozilla-release/ship-geckoview
  - hooks:trigger-hook:project-releng/cron-task-mozilla-central/ship-geckoview
  to:
  - groups:
    - mobile_releases


- grant:
  # Grant mobile the ability to see and modify their secrets
  - secrets:get:project/mobile/*
  - secrets:set:project/mobile/*
  to:
  - groups:
    - mobile_releases


# Bug 1533791 - Temporary solution so QA can run their test suites before their patches are merged in master
- grant:
  - secrets:get:project/mobile/reference-browser/firebase
  - secrets:get:project/mobile/reference-browser/nimbledroid
  to:
  - projects:
      alias:
      - reference-browser
      - kglazko-reference-browser
      job: ["branch:*"]

# Bug 1534463: allow `vpn_hg_admin` group to access Mercurial related secrets
- grant:
  - secrets:set:project/taskcluster/gecko/hgfingerprint
  - secrets:set:project/taskcluster/gecko/hgmointernal
  - secrets:get:project/taskcluster/gecko/hgfingerprint
  - secrets:get:project/taskcluster/gecko/hgmointernal
  to:
  - groups:
    - vpn_hg_admin

# Mappings from `mozilla-group`s to `project-releng:ci-group`s
# This indirection exists because modifying `mozilla-group`s requires
# access to the root credentials.
- grant:
  - assume:project:releng:ci-group:mobile_releases
  to:
  - roles:
    - mozilla-group:mobile_releases
- grant:
  - assume:project:releng:ci-group:sherrifs
  to:
  - roles:
    - mozilla-group:sherrifs

# These grants are directly to the mozilla-group roles as they need
# are the root of available scopes.
- grant:
  - assume:github-admin:*
  - assume:hook-id:*
  - assume:login-identity:*
  - assume:moz-tree:*
  - assume:mozillians-group:*
  - assume:mozillians-user:*
  - assume:project-admin:*
  - assume:project:*
  - assume:repo:*
  - assume:worker-pool:*
  - assume:worker-type:*
  - auth:*
  - docker-worker:*
  - generic-worker:*
  - github:*
  - hooks:*
  - in-tree:*
  - index:*
  - notify:*
  - project:*
  - purge-cache:*
  - queue:*
  - scheduler:*
  - secrets:*
  - worker-manager:*
  - worker:*
  to:
  - roles:
    - mozilla-group:team_relops
    - mozilla-group:releng

- grant:
  - aws-provisioner:*
  - ec2-manager:*
  to:
  - roles:
    - mozilla-group:team_relops
    - mozilla-group:releng
  environments:
    - legacy
